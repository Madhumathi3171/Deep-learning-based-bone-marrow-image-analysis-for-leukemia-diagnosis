loaded_model = tf.keras.models.load_model('dc_cbam_inceptionv3_model.h5', custom_objects={'CBAMBlock': CBAMBlock})

def predict_image(img_path, model, class_labels):
    from tensorflow.keras.preprocessing import image
    img = image.load_img(img_path, target_size=(128, 128))
    img_array = image.img_to_array(img)
    img_array = np.expand_dims(img_array, axis=0)
    img_array = img_array / 255.0

    pred_probs = model.predict(img_array)
    pred_class = np.argmax(pred_probs, axis=1)[0]
    confidence = np.max(pred_probs)

    pred_label = class_labels[pred_class]

    plt.imshow(img)
    plt.axis('off')
    plt.title(f"Predicted: {pred_label} ({confidence*100:.2f}%)")
    plt.show()

    print("\nPredicted Class:", pred_label)
    print("Confidence:", f"{confidence*100:.2f}%")

img_path = 'test_image/WBC-Malignant-Pro-026.jpg'  # Change to your test image path
predict_image(img_path, loaded_model, class_labels)


img_path = 'test_image/WBC-Benign-013.jpg'  # Change this path
img = image.load_img(img_path, target_size=(128, 128))
img_array = image.img_to_array(img) / 255.0
img_array = np.expand_dims(img_array, axis=0)

pred_probs = loaded_model.predict(img_array)
pred_class = np.argmax(pred_probs[0])
pred_label = class_labels[pred_class]
print(f"\nPredicted Class: {pred_label}")
print(f"Confidence: {np.max(pred_probs[0])*100:.2f}%")

last_conv_layer_name = None
for layer in reversed(loaded_model.layers):
    if isinstance(layer, tf.keras.layers.Conv2D):
        last_conv_layer_name = layer.name
        break
print(f"ðŸŽ¯ Using last conv layer: {last_conv_layer_name}")

grad_model = tf.keras.models.Model(
    [loaded_model.inputs],
    [loaded_model.get_layer(last_conv_layer_name).output, loaded_model.output]
)

with tf.GradientTape() as tape:
    conv_outputs, predictions = grad_model(img_array)
    loss = predictions[:, pred_class]

grads = tape.gradient(loss, conv_outputs)
pooled_grads = tf.reduce_mean(grads, axis=(0, 1, 2))
conv_outputs = conv_outputs[0]
heatmap = tf.reduce_sum(tf.multiply(pooled_grads, conv_outputs), axis=-1)
heatmap = np.maximum(heatmap, 0) / np.max(heatmap)
heatmap = cv2.resize(heatmap, (128, 128))


background = next(train_generator)[0][:5]  # 5 background images
explainer = shap.GradientExplainer(loaded_model, background)
shap_values = explainer.shap_values(img_array)

if isinstance(shap_values, list):
    print(f"SHAP returned {len(shap_values)} class explanations")
    shap_to_plot = shap_values[pred_class]
else:
    shap_to_plot = shap_values

img_display = np.clip(img_array[0] * 255, 0, 255).astype(np.uint8)
shap_to_plot = shap_to_plot / np.max(np.abs(shap_to_plot))

heatmap_shap = np.mean(shap_to_plot[0], axis=-1)
heatmap_shap = np.maximum(heatmap_shap, 0) / np.max(heatmap_shap)
heatmap_shap = cv2.resize(heatmap_shap, (128, 128))
heatmap_shap_color = cv2.applyColorMap(np.uint8(255 * heatmap_shap), cv2.COLORMAP_JET)
shap_overlay = cv2.addWeighted(img_display, 0.6, heatmap_shap_color, 0.4, 0)

plt.figure(figsize=(12, 5))

plt.subplot(1, 3, 1)
plt.imshow(cv2.cvtColor(orig_img, cv2.COLOR_BGR2RGB))
plt.title("Original Image")
plt.axis('off')

plt.subplot(1, 3, 2)
plt.imshow(cv2.cvtColor(shap_overlay, cv2.COLOR_BGR2RGB))
plt.title("SHAP (Pixel Importance)")
plt.axis('off')

plt.tight_layout()
plt.show()
